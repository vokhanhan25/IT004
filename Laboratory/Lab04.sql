CREATE DATABASE QLSACH

USE QLSACH 

/*Cau 1*/

CREATE TABLE TACGIA (
		MaTG CHAR(5) CONSTRAINT TACGIA_MaTG_PK PRIMARY KEY,
		HoTen VARCHAR(20),
		DiaChi VARCHAR(20),
		NgSinh SMALLDATETIME,
		SoDT VARCHAR(15)
)

CREATE TABLE SACH (
		MaSach CHAR(5) CONSTRAINT SACH_MaSach_PK PRIMARY KEY,
		TenSach VARCHAR(25),
		TheLoai VARCHAR(25)
)

CREATE TABLE TACGIA_SACH (
		MaTG CHAR(5),
		MaSach CHAR(5),
		CONSTRAINT TACGIA_SACH_MaTG_MaSach_PK PRIMARY KEY(MaTG, MaSach)
)

CREATE TABLE PHATHANH (
		MaPH CHAR(5),
		MaSach CHAR(5),
		NgayPH SMALLDATETIME,
		SoLuong INT,
		NhaXuatBan VARCHAR(20),
		CONSTRAINT PHATHANH_MaPH_MaSach_PK PRIMARY KEY(MaPH, MaSach)
)

SET DATEFORMAT DMY

INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG01', 'Vo Khanh An', 'KTX DHQG Khu A', '25/12/2001', '0918407765')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG02', 'Vo Khanh Minh', 'Ca Mau', '22/04/2010', '0918807373')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG03', 'Phung Thi Hong Dao', 'Binh Thanh', '12/02/2000', '0839044200')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG04', 'Nguyen Van A', 'Dia Chi A', '01/01/1990', '0918111111')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG05', 'Nguyen Van B', 'Dia Chi B', '01/01/1991', '0918111112')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG06', 'Nguyen Van C', 'Dia Chi C', '01/01/1992', '0918111113')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG07', 'Nguyen Van D', 'Dia Chi D', '01/01/1993', '0918111114')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG08', 'Nguyen Van E', 'Dia Chi E', '01/01/1994', '0918111115')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG09', 'Nguyen Van F', 'Dia Chi F', '01/01/1995', '0918111116')
INSERT INTO TACGIA(MaTG, HoTen, DiaChi, NgSinh, SoDT) VALUES('TG10', 'Nguyen Van G', 'Dia Chi G', '01/01/1996', '0918111117')

INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S01', 'Book 1', 'The Loai 1')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S02', 'Book 2', 'The Loai 1')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S03', 'Book 3', 'The Loai 2')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S04', 'Book 4', 'The Loai 4')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S05', 'Book 5', 'The Loai 2')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S06', 'Book 6', 'The Loai 1')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S07', 'Book 7', 'The Loai 3')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S08', 'Book 8', 'The Loai 3')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S09', 'Book 9', 'The Loai 4')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S10', 'Book 10', 'The Loai 2')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S11', 'Book 11', 'Van Hoc')
INSERT INTO SACH(MaSach, TenSach, TheLoai) VALUES('S13', 'Book 13', 'Van Hoc')



INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG01', 'S03')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG01', 'S06')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG01', 'S10')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG03', 'S03')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG02', 'S04')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG06', 'S10')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG01', 'S07')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG07', 'S02')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG08', 'S03')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG09', 'S04')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG03', 'S11')
INSERT INTO TACGIA_SACH(MaTG, MaSach) VALUES('TG01', 'S13')

INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH01', 'S02', '1/1/2020', 15, 'NXB 1')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH02', 'S03', '1/1/2021', 25, 'NXB 1')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH03', 'S04', '1/1/2019', 40, 'NXB 4')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH04', 'S05', '2/1/2020', 10, 'NXB 5')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH05', 'S02', '3/1/2020', 60, 'NXB 10')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH06', 'S10', '4/1/2020', 55, 'NXB 5')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH07', 'S09', '20/11/2020', 35, 'NXB 2')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH08', 'S08', '24/12/2020', 100, 'NXB 4')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH09', 'S07', '1/12/2020', 95, 'NXB 6')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH10', 'S04', '7/1/2020', 80, 'NXB 9')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH11', 'S11', '9/7/2019', 3000, 'NXB Tre')
INSERT INTO PHATHANH(MaPH, MaSach, NgayPH, SoLuong, NhaXuatBan) VALUES('PH12', 'S13', '9/8/2018', 5000, 'NXB Tre')


/*Cau 3*/

/*3.1*/
SELECT TACGIA.MaTG, HoTen, SoDT 
FROM TACGIA, TACGIA_SACH, PHATHANH, SACH  
WHERE TACGIA.MaTG = TACGIA_SACH.MaTG AND TACGIA_SACH.MaSach = SACH.MaSach AND  TACGIA_SACH.MaSach = PHATHANH.MaSach
AND TheLoai = 'Van Hoc' AND NhaXuatBan = 'NXB Tre'

/*3.2*/

SELECT DISTINCT NhaXuatBan 
FROM PHATHANH, SACH 
WHERE PHATHANH.MaSach = SACH.MaSach
GROUP BY NhaXuatBan 
HAVING COUNT(TheLoai) >= ALL (SELECT TOP 1 COUNT(TheLoai)
							  FROM PHATHANH, SACH 
							  WHERE PHATHANH.MaSach = SACH.MaSach
							  GROUP BY NhaXuatBan
							  ORDER BY COUNT(TheLoai) DESC
							 )
/*3.3*/

SELECT DISTINCT TACGIA.MaTG, HoTen 
FROM TACGIA, PHATHANH, TACGIA_SACH  
WHERE TACGIA.MaTG = TACGIA_SACH.MaTG AND TACGIA_SACH.MaSach = PHATHANH.MaSach
GROUP BY TACGIA.MaTG, HoTen, NhaXuatBan
HAVING COUNT(MaPH) >= ALL(SELECT TOP 1 COUNT (MaPH)
						  FROM TACGIA, PHATHANH, TACGIA_SACH
						  WHERE TACGIA.MaTG = TACGIA_SACH.MaTG AND TACGIA_SACH.MaSach = PHATHANH.MaSach
						  GROUP BY TACGIA.MaTG, HoTen, NhaXuatBan
						  ORDER BY COUNT(MaPH) DESC
						  )





